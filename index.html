<script>
    async function fetchExchangePrices() {
        const exchanges = [
            { name: 'Bitstamp', url: 'https://www.bitstamp.net/api/v2/ticker/btcusd/' },
            { name: 'Coinbase', url: 'https://api.coinbase.com/v2/prices/spot?currency=USD' },
            { name: 'Kraken', url: 'https://api.kraken.com/0/public/Ticker?pair=XBTUSD' },
            { name: 'Binance', url: 'https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT' }
        ];

        let exchangePricesHTML = '';
        let totalPrice = 0;
        let priceCount = 0;

        for (let exchange of exchanges) {
            try {
                const response = await fetch(exchange.url);
                const data = await response.json();
                let price = null;

                switch (exchange.name) {
                    case 'Bitstamp':
                        price = parseFloat(data.last);
                        break;
                    case 'Coinbase':
                        price = parseFloat(data.data.amount);
                        break;
                    case 'Kraken':
                        const krakenPair = data.result.XXBTZUSD || data.result.XXBTUSD;
                        if (krakenPair) {
                            price = parseFloat(krakenPair.c[0]);
                        }
                        break;
                    case 'Binance':
                        price = parseFloat(data.price);
                        break;
                }

                if (price !== null && !isNaN(price)) {
                    exchangePricesHTML += `<div class="small-text">${exchange.name}: <span class="data-value">$${price.toLocaleString()}</span></div>`;
                    totalPrice += price;
                    priceCount++;
                } else {
                    exchangePricesHTML += `<div class="small-text">${exchange.name}: <span class="data-value">N/A</span></div>`;
                }
            } catch (error) {
                console.error(`Error fetching price from ${exchange.name}:`, error);
                exchangePricesHTML += `<div class="small-text">${exchange.name}: <span class="data-value">Error</span></div>`;
            }
        }

        document.getElementById('exchange-prices').innerHTML = exchangePricesHTML;

        if (priceCount > 0) {
            const averagePrice = totalPrice / priceCount;
            const formattedPrice = `$${averagePrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

            // Update the exchange average price on the page
            document.getElementById('average-price').innerText = formattedPrice;

            // Update the title with the exchange average price
            document.title = `BTC: ${formattedPrice} - BeSovereign`;  // Update tab title
        } else {
            document.getElementById('average-price').innerText = 'N/A';
            document.title = 'BeSovereign';
        }
    }

    window.onload = function() {
        fetchBlockHeight();
        fetchExchangePrices();
        fetchFeeEstimates();
        updateTime();
        setInterval(updateTime, 1000); // Update time every second
    };
</script>
